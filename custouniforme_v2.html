<html>
<head>
	<title>Labirinto</title>
<link href="style.css" media="all" rel="stylesheet" />
<script type="text/javascript" src="matrix.js"></script>

<script type="text/javascript">

function setClass(yVal,xVal,classe){
	document.getElementById('y'+yVal+'x'+xVal).className = classe;
}
var pesoD = 300;
var ipesoC = 0;

function setPesoD(){
	return pesoD = pesoD * 0.9;
}
function getPesoD(){
	return pesoD;
}

function setPesoC(){
	return ipesoC++;
}
function getPesoC(){
	var pesosC = [60,80,100,120,140,160,180,200,220,250];
	return pesosC[ipesoC];
}

function checkPeso(y,x){
	var pesos = [
					{
						nome: 'I',
						peso: 0,
					},
					{
						nome: '.',
						peso: 1
					},
					{
						nome: 'G',
						peso: 5
					},
					{
						nome: 'D',
						peso: getPesoD()
					},
					{
						nome: 'C',
						peso: getPesoC()
					},
					{
						nome: 'F',
						peso: 0,
					}
				];

	pontoValor = matriz[y][x];
	for (let i in pesos) {
		if(pesos[i].nome == pontoValor){
			return pesos[i].peso;
		}
	}
}


var Tree = [];
var visitedTree = [];

window.y = 36;
window.x = 4;

function getVizinhos(y,x) {

	if((x > 39 || y > 39) || x < 1 || y < 1){
		return false;
	}

	var vizinhos = [{
						y: y-1,
						x: x
					},
					{
						y: y+1,
						x: x
					},
					{
						y: y,
						x: x-1
					},
					{
						y: y,
						x: x+1
					}];

	// for(let v in vizinhos){
	// 	if(vizinhos[v].y > )
	// }

	// adiciona no vetor visitedTree os nós que já tiveram seus filhos visitados
	if(visitedTree.length > 0){
		for(let vt in visitedTree){
			for(let v in vizinhos){
				if(vizinhos[v].y == visitedTree[vt].y && vizinhos[v].x == visitedTree[vt].x){
					vizinhos.splice(v,1);
				}
			}
		}
	}
	return vizinhos;
}


function Node(y,x,parent) {

    this.y = y;
    this.x = x;
    this.value = matriz[y][x];

    if(flagBusca == 'uniforme'){
        if(parent){
            this.peso = checkPeso(y,x) + checkPeso(parent.y,parent.x);
        }
        else{
            this.peso = checkPeso(y,x);
        }
    } else if (flagBusca == 'gulosa'){
        var d1 = (this.x - 36) * (this.x - 36);
        var d2 = (this.y - 36) * (this.y - 36);
        var resultado = Math.sqrt(d1 + d2);

        if(parent){
            this.peso = resultado;
            //checkPeso(y,x) + checkPeso(parent.y,parent.x);
        }
        else{
            this.peso = 0;
            //checkPeso(y,x);
        }

    } else if (flagBusca == 'astar'){
        var d1 = (this.x - 36) * (this.x - 36);
        var d2 = (this.y - 36) * (this.y - 36);
        var resultado = Math.sqrt(d1 + d2);

        if(parent){
            this.peso = checkPeso(y,x) + checkPeso(parent.y,parent.x) + resultado;
        }
        else{
            this.peso = checkPeso(y,x) + 0;
        }

    }
	this.parent = parent;
}

function sortNumbers(a, b) {
	return a.peso - b.peso;
}

function addNode(data) {

	// verifica se já existe um nó de mesmo peso e coordenadas no array
	let encontrado = false;
	for(let t in Tree){
		if(data.y == Tree[t].y && data.x == Tree[t].x && data.peso >= Tree[t].peso){
			encontrado = true;
		}
	}
	if(encontrado == false){
		if(data.value == 'C'){
			setPesoC();
			// console.log(data);
		}
		else if(data.value == 'D'){
			// console.log(data);
			setPesoD();
		}

	  	Tree.push(data);
		setClass(data.y,data.x,'visitou');
	}
}

function trajeto(node){

	setTimeout(function(){

		setClass(node.y,node.x,'verde');

		if(node.y != window.y || node.x != window.x){
			return trajeto(node.parent);
		}
		else{
			reloadCount = 1;
			return;
		}
	}, 20);
}

function buscaGenerica(){

	let yVal = Tree[0].y;
	let xVal = Tree[0].x;

	node = {y:yVal, x:xVal}
	visitedTree.push(node);

	var vizinhos = getVizinhos(yVal,xVal);
	// adiciona os vizinhos no array
	for (var v in vizinhos) {
		addNode(new Node(vizinhos[v].y,vizinhos[v].x,Tree[0]));
	}

	// remove o primeiro elemento do array
	Tree.splice(0,1);

	// ordena o array por pesos
	Tree.sort(sortNumbers);

	// enquanto não encontrar o fim executa a funcao novamente
	if(Tree[0].value != 'F'){
		buscaGenerica();
	}
	else{
		// quando encontrou o fim faz o trajeto de volta
		trajeto(Tree[0]);
	}

	// console.log(Tree);
}

function mostraMatriz(){
	var classe;
	var html = '';
	for (let y = 0; y < matriz.length; y++) {
		for (let x = 0; x < matriz[y].length; x++) {

			switch(matriz[y][x]){
				case 'D': classe = 'cinzaEscuro';break;
				case 'G': classe = 'cinzaClaro';break;
				case 'C': classe = 'amarelo';break;
				case 'I': classe = 'laranja';break;
				case 'F': classe = 'verde';break;
				default: classe = '';

			}
			html += '<div id="y'+y+'x'+x+'" class="'+classe+'">' + matriz[y][x] + '</div>';
			// html += '<div id="y'+y+'x'+x+'" class="'+classe+'">' + matriz[y][x] + y + x + '</div>';
		}
		html += '<br class="clear">';
	}
	document.getElementById("matriz").innerHTML = html;

	// pra nao fazer uma busca pelo I, já defini o ponto de partida
	// adicionando o primero nó no array
	addNode(new Node(window.y,window.x,null));
}

var flagBusca;
var reloadCount = 0;

//Função para recarregar a matriz quando clicar em algum botão
//pela segunda vez. Esvazia a Tree[] e a visitedTree[]
function reload(){
    Tree = [];
    visitedTree = [];
    mostraMatriz();

    console.log("TREE: ", Tree);
}

//Setta a flag uniforme, para diferenciar na escolha dos algoritmos
//na função Node(y,x,parent)
function buscaUniforme(flag){
    console.log("uniforme", flag);
    flagBusca = flag;
    if(reloadCount == 1){
        reload();
	}
    buscaGenerica();
}

//Setta a flag gulosa, para diferenciar na escolha dos algoritmos
//na função Node(y,x,parent)
function buscaGulosa(flag){
    console.log("gulosa", flag);
    flagBusca = flag;
    if(reloadCount == 1){
        reload();
    }
    buscaGenerica();
}

//Setta a flag astar, para diferenciar na escolha dos algoritmos
//na função Node(y,x,parent)
function buscaAStar(flag){
    console.log("astar", flag);
    flagBusca = flag;
    if(reloadCount == 1){
        reload();
    }
    buscaGenerica();
}


</script>
</head>
<body onLoad="mostraMatriz()">
	
	<div id="button">
	<button onClick=buscaUniforme("uniforme")>Busca Uniforme</button>
	<button onClick=buscaGulosa("gulosa")>Busca Gulosa</button>
	<button onClick=buscaAStar("astar")>Busca A Star</button>
	</div>
	
	<div id="matriz"></div>
	
</body>
</html>